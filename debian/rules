#! /usr/bin/make -f

include /usr/share/quilt/quilt.make

##

cmake_flags := \
	-DCMAKE_SKIP_RPATH=true				\
	-DCMAKE_BUILD_TYPE=Debian			\
	-DCMAKE_INSTALL_PREFIX=/usr			\
	-DCMAKE_VERBOSE_MAKEFILE=ON			\
							\
	-DKDE4_BUILD_TESTS=false			\
	-DKDE4_USE_ALWAYS_FULL_RPATH=false		\
	-DKDE_DISTRIBUTION_TEXT="Debian packages"	\
							\
	-DLIB_INSTALL_DIR=/usr/lib			\
	-DSYSCONF_INSTALL_DIR=/etc			\
	-DCONFIG_INSTALL_DIR=/etc/kde4			\
	-DDATA_INSTALL_DIR=/usr/share/kde4/apps		\
	-DHTML_INSTALL_DIR=/usr/share/doc/kde4/HTML	\
	-DKCFG_INSTALL_DIR=/usr/share/kde4/config.kcf	\
	-DCMAKE_EXE_LINKER_FLAGS="-Wl,--as-needed"	\
	-DCMAKE_SHARED_LINKER_FLAGS="-Wl,--as-needed"	\
	-DCMAKE_MODULE_LINKER_FLAGS="-Wl,--as-needed"

# OK, here we disable all that we don't want.
# Please remove lines as you add packaging support for them.
# Do NOT remove ENABLE_PYKDE4, it gets special handling below. -- Dato
# PHONON_SMOKE seems broken, but nice to have in future. Sune Vuorela. Version 4.0.84
cmake_flags += \
	-DENABLE_PYKDE4=OFF\
	-DENABLE_PHONON_SMOKE=OFF \
	-DENABLE_PLASMA_SHARP=OFF \
	-DENABLE_SOPRANO_SMOKE=ON \
	-DENABLE_KHTML_SHARP=ON \
	-DENABLE_PHONON_RUBY=OFF

##

DEB_HOST_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

objdir = $(CURDIR)/obj-$(DEB_HOST_GNU_TYPE)

##

CFLAGS = -Wall -g

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
    CFLAGS += -O0
else
    CFLAGS += -O2
endif

##

pydefault  := $(shell pyversions --default)
pyversions := $(shell pyversions --supported --version)
cmake_flags += -DPYTHON_EXECUTABLE=/usr/bin/$(pydefault)

##

$(objdir)/Makefile: $(QUILT_STAMPFN)
	mkdir -p $(objdir)
	cd $(objdir) && cmake $(CURDIR) $(cmake_flags) \
	    -DCMAKE_C_FLAGS="$(CFLAGS)" -DCMAKE_CXX_FLAGS="$(CFLAGS)"

##

$(patsubst %,$(objdir)/python/pykde4-%/Makefile,$(pyversions)): $(objdir)/Makefile
	mkdir -p $(@D)	
	cd  $(@D) && cmake $(CURDIR)/python/pykde4 $(cmake_flags) \
	    -DPYTHON_EXECUTABLE=/usr/bin/python$(subst $(objdir)/python/pykde4-,,$(subst /Makefile,,$@)) 

##

build: build-stamp
build-stamp: $(objdir)/Makefile $(patsubst %,$(objdir)/python/pykde4-%/Makefile,$(pyversions))
	$(MAKE) -C $(objdir)
	
	set -e; for v in $(pyversions); do \
	    make -C $(objdir)/python/pykde4-$$v; \
	done
	
	touch $@

##

clean: unpatch
	dh_testdir
	dh_testroot
	
	rm -f build-stamp
	rm -rf $(objdir)
	
	dh_clean

##

install:
	dh_testdir
	dh_testroot
	$(MAKE) -C $(objdir) install DESTDIR=$(CURDIR)/debian/tmp
	
	set -e; for v in $(pyversions); do \
	    make -C $(objdir)/python/pykde4-$$v install DESTDIR=$(CURDIR)/debian/tmp; \
	done
	
	cd debian/tmp/usr/share/doc/kde4/HTML/PyKDE4 && \
	    rm -f COPYING.html COPYING.LESSER.html CREATIVECOMMONS.html && \
	    rmdir "creative commons_files"
	
	dh_install
	install -D -m 755 debian/tmp/usr/share/kde4/apps/pykde4/pykdeuic4.py \
	    debian/python-kde4-dev/usr/bin/pykdeuic4

##

binary: binary-arch binary-indep

binary-arch: build install
	$(MAKE) -f debian/rules DH_OPTIONS=-s binary-common

binary-indep: build install
	$(MAKE) -f debian/rules DH_OPTIONS=-i binary-common

binary-common:
	dh_testdir
	dh_testroot
	dh_installchangelogs
	dh_installdocs
	dh_installexamples
	dh_installman
	dh_pycentral
	dh_link
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb


##

.PHONY: build clean install binary binary-arch binary-indep binary-common
